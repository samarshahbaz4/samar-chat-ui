<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samar Ai</title>

<!-- Performance Optimizations -->
<link rel="preconnect" href="https://generativelanguage.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<!-- PWA Support -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00668b">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- KaTeX for LaTeX Math Rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOVEMeaOVTfFpgzxC_DUVKcqSelfNsfnocpDqsmuUftpNFXGkDoA" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>

<style>
    :root {
        --bg-color: #f0f2f5;
        --surface-color: #ffffff;
        --primary-color: #00668b;
        --on-primary-color: #ffffff;
        --text-primary-color: #1c1c1e;
        --text-secondary-color: #5c5c60;
        --border-color: #d1d1d6;
        --dot-green: #34c759;
        --dot-yellow: #ffcc00;
        --dot-blue: #007aff;
        --dot-red: #ff3b30;
    }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0; padding: 0;
        background-color: var(--bg-color);
        color: var(--text-primary-color);
        display: flex; flex-direction: column;
        height: 100vh; overflow: hidden;
    }
    * { box-sizing: border-box; }
    .app-container {
        display: flex; flex-direction: column;
        height: 100%; width: 100%;
        max-width: 800px; margin: 0 auto;
        background-color: var(--bg-color);
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        position: relative;
    }
    #chat-window {
        flex-grow: 1;
        overflow-y: auto;
        padding: 16px 0;
        background-color: var(--bg-color);
        border-top: 1px solid var(--border-color);
        scroll-behavior: smooth;
    }
    .message { display: flex; margin-bottom: 12px; max-width: 90%; position: relative; }
    .message .content { padding: 10px 14px; border-radius: 18px; word-wrap: break-word; line-height: 1.5; }
    
    .message.user {
        justify-content: flex-end;
        margin-left: auto;
        padding: 0 16px; 
    }
    .message.user .content { background-color: var(--primary-color); color: var(--on-primary-color); border-bottom-right-radius: 4px; }
    
    .message.ai {
        justify-content: flex-start;
        margin-right: auto;
        max-width: 100%; 
    }
    .message.ai .content {
        background-color: transparent;
        color: var(--text-primary-color);
        width: 100%;
        border-radius: 0; 
        padding: 10px 16px; 
    }

    .message .content p:first-child { margin-top: 0; }
    .message .content p:last-child { margin-bottom: 0; }
    .message .content pre { background-color: #2d2d2d; color: #e3e3e3; padding: 12px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; margin: 0 16px; }
    
    .message.ai .content { max-width: 70ch; }
    .message.ai .content * + * { margin-top: 1em; }
    .message.ai .content h1, .message.ai .content h2, .message.ai .content h3, .message.ai .content h4, .message.ai .content h5, .message.ai .content h6 { line-height: 1.25; font-weight: 700; }
    .message.ai .content h1 { font-size: 2.0em; padding-bottom: 0.3em; border-bottom: 1px solid var(--border-color); }
    .message.ai .content h2 { font-size: 1.6em; padding-bottom: 0.2em; border-bottom: 1px solid var(--border-color); }
    .message.ai .content h3 { font-size: 1.3em; }
    .message.ai .content h4 { font-size: 1.15em; }
    .message.ai .content ul, .message.ai .content ol { padding-left: 2em; }
    .message.ai .content li + li { margin-top: 0.5em; }
    .message.ai .content blockquote { margin-left: 1em; padding-left: 1em; border-left: 3px solid var(--border-color); color: var(--text-secondary-color); }
    .message.ai .content code { font-family: monospace; background-color: color-mix(in srgb, var(--border-color) 30%, transparent); padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; }
    .message.ai .content pre code { background-color: transparent; padding: 0; border-radius: 0; }
    .message.ai .content a { color: var(--primary-color); text-decoration: none; }
    .message.ai .content a:hover { text-decoration: underline; }
    .message.ai .content hr { border: 0; height: 1px; background-color: var(--border-color); }

    .message-buttons {
        position: absolute; bottom: 8px; right: 16px;
        display: flex; gap: 6px;
        opacity: 0; transition: opacity 0.2s;
        z-index: 1;
    }
    .message.ai:hover .message-buttons { opacity: 1; }
    
    .copy-btn, .export-msg-btn {
        background-color: var(--surface-color); border: 1px solid var(--border-color);
        border-radius: 50%; width: 28px; height: 28px; cursor: pointer; 
        display: flex; align-items: center; justify-content: center;
        color: var(--text-secondary-color); transition: color 0.2s;
    }
    .copy-btn.copied { color: var(--dot-green); }

    .table-wrapper { overflow-x: auto; margin: 1em 16px; } 
    .message .content table { width: 100%; border-collapse: collapse; table-layout: fixed; border: 1px solid var(--border-color); background-color: var(--surface-color); }
    .message .content th, .message .content td { padding: 8px 12px; border: 1px solid var(--border-color); text-align: left; white-space: normal; word-wrap: break-word; }
    .message .content th { background-color: color-mix(in srgb, var(--bg-color) 70%, white); font-weight: 600; }
    
    .incomplete-warning {
        margin-top: 1em; padding: 8px 12px; background-color: color-mix(in srgb, var(--dot-yellow) 15%, transparent);
        border-radius: 8px; font-size: 0.85em; color: var(--text-secondary-color);
    }

    .typing-indicator {
        padding: 0; font-weight: bold; letter-spacing: 2px;
        font-size: 1.5em; color: var(--text-secondary-color);
    }
    .typing-indicator::after { content: '•'; animation: dots 1.4s infinite; }
    @keyframes dots { 0% { content: '•'; } 33% { content: '••'; } 66% { content: '•••'; } }

    #status-bar { display: flex; justify-content: space-between; align-items: center; padding: 4px 12px; border-top: 1px solid var(--border-color); background-color: var(--bg-color); flex-shrink: 0; }
    #connection-status { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary-color); }
    #connection-status .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot.green { background-color: var(--dot-green); } .dot.yellow { background-color: var(--dot-yellow); }
    .dot.blue { background-color: var(--dot-blue); } .dot.red { background-color: var(--dot-red); }

    #status-bar-right { display: flex; align-items: center; gap: 8px; }
    .scroll-btn, #new-chat-btn, .quick-prompt-btn, .icon-btn, .retry-btn, .refresh-btn, .copy-btn, .export-msg-btn { transition: transform 0.1s, background-color 0.1s; }
    .scroll-btn:active, #new-chat-btn:active, .quick-prompt-btn:active, .icon-btn:active, .retry-btn:active, .refresh-btn:active, .copy-btn:active, .export-msg-btn:active { transform: scale(0.95); background-color: var(--bg-color); }
    .scroll-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary-color); width: 28px; height: 28px; border-radius: 50%; font-size: 1.1rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #new-chat-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary-color); padding: 4px 10px; border-radius: 16px; font-size: 0.8rem; cursor: pointer; }
    .error-container { text-align: center; }
    .error-container p { color: var(--dot-red); font-size: 0.9rem; margin-bottom: 8px; }
    .retry-btn { background: none; border: 1px solid var(--border-color); color: var(--text-secondary-color); padding: 4px 12px; border-radius: 16px; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
    #chat-form { display: flex; flex-direction: column; padding: 10px; border-top: 1px solid var(--border-color); background-color: var(--bg-color); flex-shrink: 0; gap: 8px; }
    #top-input-bar { display: flex; align-items: center; gap: 8px; }
    .quick-prompt-btn {
        background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-secondary-color); padding: 4px 8px;
        border-radius: 16px; font-size: 0.8rem; cursor: pointer; min-width: 65px; text-align: center;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    #main-model-select {
        -webkit-appearance: none; appearance: none; margin-left: auto; padding: 4px 10px; border: 1px solid var(--border-color);
        border-radius: 16px; font-size: 0.8rem; background-color: var(--bg-color); max-width: 120px; flex-shrink: 0;
    }
    .icon-btn { background: none; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary-color); flex-shrink: 0; padding: 0; }
    .input-row { display: flex; align-items: flex-end; width: 100%; gap: 8px; }
    #message-input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 16px; font-size: 1rem; resize: none; max-height: 150px; overflow-y: auto; background-color: var(--surface-color);}
    #message-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color) 20%, transparent); }
    #send-button { background-color: var(--primary-color); color: var(--on-primary-color); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; transition: transform 0.1s, background-color 0.2s; }
    #send-button:active { transform: scale(0.92); }
    #send-button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
    #send-button.stop-generating { background-color: var(--dot-red); }
    
    #show-bars-btn {
        display: none; position: absolute; bottom: 16px; right: 16px; z-index: 101; 
        background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-secondary-color);
        border-radius: 50%; width: 44px; height: 44px; cursor: pointer;
        align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.1s;
    }
    #page-down-btn {
        display: none; position: absolute; bottom: 16px; right: 70px; /* Positioned left of show-bars-btn */
        z-index: 101; 
        background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-secondary-color);
        border-radius: 50%; width: 44px; height: 44px; cursor: pointer;
        align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: transform 0.1s;
    }

    #show-bars-btn:active, #page-down-btn:active { transform: scale(0.92); }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
    .modal-content { background-color: var(--bg-color); position: absolute; top: 0; right: -100%; width: 90%; max-width: 400px; height: 100%; box-shadow: -2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; animation: slideIn 0.3s forwards; }
    .modal.active { display: block; }
    .modal.active .modal-content { right: 0; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { right: -100%; } to { right: 0; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color); }
    .modal-header h2 { margin: 0; font-size: 1.2rem; }
    .close-btn { font-size: 2rem; background: none; border: none; cursor: pointer; }
    .modal-body { padding: 16px; overflow-y: auto; flex-grow: 1; }
    .settings-group { background-color: var(--surface-color); border-radius: 12px; margin-bottom: 16px; padding: 8px 16px; }
    .settings-group h3 { font-size: 1rem; color: var(--primary-color); margin-bottom: 12px; }
    .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--bg-color); }
    .setting-item:last-child { border-bottom: none; }
    .setting-item label { font-size: 1rem; flex-shrink: 0; margin-right: 12px; }
    .setting-item small { font-size: 0.8rem; color: var(--text-secondary-color); display: block; margin-top: 4px; }
    .setting-item .setting-input { width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; margin-top: 8px; }
    .prompt-inputs-container { display: flex; gap: 8px; width: 100%; }
    .refresh-btn-container { display: flex; justify-content: center; padding-top: 8px; }
    .refresh-btn { padding: 8px 16px; font-size: 0.9rem; border-radius: 20px; border: 1px solid var(--primary-color); background: none; color: var(--primary-color); cursor: pointer; }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(20px); }
    .modal-footer { padding: 16px; text-align: center; font-size: 0.8rem; color: var(--text-secondary-color); border-top: 1px solid var(--border-color); background-color: var(--surface-color); }
    .slider-container { display: flex; align-items: center; gap: 12px; width: 100%; }
    .slider-container input[type="range"] { flex-grow: 1; }
    .setting-disabled { opacity: 0.5; pointer-events: none; }

    @media print {
        body, html { background-color: #fff; color: #000; }
        body > *:not(.app-container), 
        .app-container > *:not(#chat-view),
        #chat-view > *:not(#chat-window),
        .modal, .message-buttons {
            display: none !important;
        }
        .app-container, #chat-view, #chat-window {
            display: block !important; position: static !important; height: auto !important;
            width: 100% !important; max-width: none !important; box-shadow: none !important;
            border: none !important; overflow: visible !important; padding: 0 !important;
            margin: 0 !important; background-color: transparent !important;
        }
        .message { max-width: 100% !important; page-break-inside: avoid; }
        .message.user { padding: 0 !important; }
        .message.user .content { background-color: #e0e0e0 !important; color: #000 !important; }
        .message.ai .content { background-color: #f9f9f9 !important; color: #000 !important; border: 1px solid #ddd; max-width: none !important; }
    }
</style>
</head>
<body>
    <div class="app-container">
        <main id="chat-view" style="display: flex; flex-direction: column; height: 100%;">
            <div id="chat-window"></div>
            <div id="status-bar">
                <div id="connection-status"><span class="dot yellow"></span>Initializing...</div>
                <div id="status-bar-right">
                    <button id="main-settings-btn" type="button" class="icon-btn" aria-label="Open Settings"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                    <button id="scroll-to-top-btn" class="scroll-btn" title="Previous Message">↑</button>
                    <button id="scroll-to-bottom-btn" class="scroll-btn" title="Next Message">↓</button>
                    <button id="new-chat-btn" type="button">New Chat</button>
                    <button id="hide-bars-btn" type="button" class="icon-btn" aria-label="Hide Bars" title="Hide Bars"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
                </div>
            </div>
            <form id="chat-form">
                <div id="top-input-bar">
                    <button id="quick-prompt-btn-1" type="button" class="quick-prompt-btn">Explain:</button>
                    <button id="quick-prompt-btn-2" type="button" class="quick-prompt-btn">Tell briefly:</button>
                    <button type="button" class="quick-prompt-btn">input</button>
                    <select id="main-model-select" class="main-model-select" aria-label="Select Model"></select>
                </div>
                <div class="input-row">
                    <textarea id="message-input" placeholder="Chat with Ai..." rows="1" autofocus></textarea>
                    <button id="send-button" type="submit" aria-label="Send Message"></button>
                </div>
            </form>
        </main>
        <button id="page-down-btn" type="button" aria-label="Next Message" title="Next Message"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></button>
        <button id="show-bars-btn" type="button" aria-label="Show Bars" title="Show Bars"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg></button>
    </div>
    <div id="settings-modal" class="modal"><div class="modal-content"><header class="modal-header"><h2>Settings</h2><button id="close-settings-btn" class="close-btn" aria-label="Close Settings">×</button></header>
    <div class="modal-body">
        <!-- Group 1: Export Chat -->
        <div class="settings-group">
            <h3>Export Chat</h3>
            <div class="setting-item" style="flex-direction: column; align-items: flex-start; border-bottom: none;">
                <label style="margin-bottom: 8px;">Export chat history</label>
                <div class="prompt-inputs-container">
                     <button id="export-txt-btn" class="refresh-btn" style="width:100%">Export as TXT</button>
                     <button id="export-pdf-btn" class="refresh-btn" style="width:100%">Export as PDF</button>
                </div>
            </div>
        </div>

    <!-- Group 2: System Prompt -->
    <div class="settings-group">
        <h3>System Prompt</h3>
        <div class="setting-item" style="flex-direction: column; align-items: flex-start; border-bottom: none; padding-top: 0;">
            <textarea id="system-prompt-input" class="setting-input" rows="3" placeholder="Leave empty for default behavior..." style="margin-top:0;"></textarea>
        </div>
    </div>

    <!-- Group 3: Generation Parameters -->
    <div class="settings-group">
        <h3>Generation Parameters</h3>
        <div id="thinking-budget-container" class="setting-item" style="flex-direction: column; align-items: flex-start;">
            <label for="thinking-budget-select">Thinking Budget</label>
            <small>For 2.5 models. Improves quality on complex tasks. '0' is faster.</small>
            <select id="thinking-budget-select" class="setting-input" style="margin-top: 8px; width: 100%;">
                <option value="0">0 (Fast Response)</option>
                <option value="128">128 (Higher Quality)</option>
            </select>
        </div>
        <div class="setting-item">
            <label for="temperature-toggle">Use Temperature</label>
            <label class="switch">
                <input type="checkbox" id="temperature-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div id="temperature-slider-container" class="setting-item" style="flex-direction: column; align-items: flex-start;">
            <label for="temperature-slider">Temperature</label><small>Controls randomness. Lower is more predictable.</small>
            <div class="slider-container"><input type="range" id="temperature-slider" min="0" max="1" step="0.1" class="setting-input" style="margin-top:0;">
            <span id="temperature-value-display" style="min-width: 2.5em; text-align: right;">1.0</span></div>
        </div>
        <div class="setting-item">
            <label for="top-p-toggle">Use Top-P</label>
            <label class="switch">
                <input type="checkbox" id="top-p-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div id="top-p-slider-container" class="setting-item" style="flex-direction: column; align-items: flex-start;">
            <label for="top-p-slider">Top-P</label><small>Cumulative probability sampling.</small>
            <div class="slider-container">
                <input type="range" id="top-p-slider" min="0" max="1" step="0.01" class="setting-input" style="margin-top:0;">
                <span id="top-p-value-display" style="min-width: 2.5em; text-align: right;">0.95</span>
            </div>
        </div>
        <div class="setting-item">
            <label for="top-k-toggle">Use Top-K</label>
            <label class="switch">
                <input type="checkbox" id="top-k-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div id="top-k-slider-container" class="setting-item" style="flex-direction: column; align-items: flex-start;">
            <label for="top-k-slider">Top-K</label><small>Samples from the K most likely tokens.</small>
            <div class="slider-container">
                <input type="range" id="top-k-slider" min="1" max="100" step="1" class="setting-input" style="margin-top:0;">
                <span id="top-k-value-display" style="min-width: 2.5em; text-align: right;">40</span>
            </div>
        </div>
    </div>

    <!-- Group 4: Chat & UI Behavior -->
    <div class="settings-group">
        <h3>Chat & UI Behavior</h3>
        <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
            <label>Quick Prompts</label>
            <small>Set the text for the shortcut buttons.</small>
            <div class="prompt-inputs-container">
                <input type="text" id="quick-prompt-1-input" class="setting-input" placeholder="Prompt 1">
                <input type="text" id="quick-prompt-2-input" class="setting-input" placeholder="Prompt 2">
            </div>
        </div>
        <div class="setting-item"><label for="streaming-toggle">Streaming Response</label><label class="switch"><input type="checkbox" id="streaming-toggle"><span class="slider"></span></label></div>
        <div class="setting-item"><label for="markdown-toggle">Render Markdown</label><label class="switch"><input type="checkbox" id="markdown-toggle"><span class="slider"></span></label></div>
        <div class="setting-item"><label for="auto-hide-on-send-toggle">Auto-hide on Send</label><label class="switch"><input type="checkbox" id="auto-hide-on-send-toggle"><span class="slider"></span></label></div>
        <div class="setting-item"><label for="send-on-enter-toggle">Send on Enter Key</label><label class="switch"><input type="checkbox" id="send-on-enter-toggle"><span class="slider"></span></label></div>
        <div class="setting-item"><label for="save-history-toggle">Save Chat History</label><label class="switch"><input type="checkbox" id="save-history-toggle"><span class="slider"></span></label></div>
         <div class="setting-item">
            <label for="disable-safety-toggle">Disable Safety Filters</label>
            <label class="switch">
                <input type="checkbox" id="disable-safety-toggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <!-- Group 5: API & Model -->
    <div class="settings-group">
        <h3>API & Model</h3>
        <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
            <label for="api-key-input">Gemini API Key</label>
            <small>Overrides the default key. Stored locally.</small>
            <input type="password" id="api-key-input" class="setting-input" placeholder="Enter your key">
        </div>
        <div class="refresh-btn-container">
            <button id="refresh-models-btn" class="refresh-btn">Refresh Model List</button>
        </div>
    </div>
</div>
<footer class="modal-footer"><p>This app is created by Samar Shahbaz MBBS’29.</p></footer></div></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (window.marked) {
            marked.setOptions({ gfm: true, breaks: true });
        }
        // --- Const declarations ---
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const mainSettingsBtn = document.getElementById('main-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const refreshModelsBtn = document.getElementById('refresh-models-btn');
        const modelSelect = document.getElementById('main-model-select');
        const connectionStatus = document.getElementById('connection-status');
        const newChatBtn = document.getElementById('new-chat-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        const systemPromptInput = document.getElementById('system-prompt-input');
        const streamingToggle = document.getElementById('streaming-toggle');
        const markdownToggle = document.getElementById('markdown-toggle');
        const sendOnEnterToggle = document.getElementById('send-on-enter-toggle');
        const saveHistoryToggle = document.getElementById('save-history-toggle');
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
        const temperatureSlider = document.getElementById('temperature-slider');
        const temperatureValueDisplay = document.getElementById('temperature-value-display');
        const hideBarsBtn = document.getElementById('hide-bars-btn');
        const showBarsBtn = document.getElementById('show-bars-btn');
        const pageDownBtn = document.getElementById('page-down-btn'); // New button
        const autoHideOnSendToggle = document.getElementById('auto-hide-on-send-toggle');
        const statusBar = document.getElementById('status-bar');
        const quickPrompt1Input = document.getElementById('quick-prompt-1-input');
        const quickPrompt2Input = document.getElementById('quick-prompt-2-input');
        const temperatureToggle = document.getElementById('temperature-toggle');
        const temperatureSliderContainer = document.getElementById('temperature-slider-container');
        const topPToggle = document.getElementById('top-p-toggle');
        const topPSliderContainer = document.getElementById('top-p-slider-container');
        const topPSlider = document.getElementById('top-p-slider');
        const topPValueDisplay = document.getElementById('top-p-value-display');
        const topKToggle = document.getElementById('top-k-toggle');
        const topKSliderContainer = document.getElementById('top-k-slider-container');
        const topKSlider = document.getElementById('top-k-slider');
        const topKValueDisplay = document.getElementById('top-k-value-display');
        const thinkingBudgetSelect = document.getElementById('thinking-budget-select');
        const thinkingBudgetContainer = document.getElementById('thinking-budget-container');
        const disableSafetyToggle = document.getElementById('disable-safety-toggle');
        const exportTxtBtn = document.getElementById('export-txt-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');

        const DEFAULT_API_KEY = "AIzaSyDnKMIXmkQLSteQbFfS6mmsUJACZQm4bJo"; 
        let chatHistory = [];
        let abortController = null;

        const sendIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`;
        const stopIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><rect x="6" y="6" width="12" height="12" rx="1"></rect></svg>`;
        
        const settingsConfig = {
            apiKey: { el: apiKeyInput, type: 'value', default: '' },
            systemPrompt: { el: systemPromptInput, type: 'value', default: '' },
            isSafetyDisabled: { el: disableSafetyToggle, type: 'checked', default: true },
            isTemperatureEnabled: { el: temperatureToggle, type: 'checked', default: true },
            temperature: { el: temperatureSlider, type: 'value', default: 1.0, displayEl: temperatureValueDisplay, format: v => parseFloat(v).toFixed(1) },
            isTopPEnabled: { el: topPToggle, type: 'checked', default: true },
            topP: { el: topPSlider, type: 'value', default: 0.95, displayEl: topPValueDisplay, format: v => parseFloat(v).toFixed(2) },
            isTopKEnabled: { el: topKToggle, type: 'checked', default: true },
            topK: { el: topKSlider, type: 'value', default: 40, displayEl: topKValueDisplay, format: v => parseInt(v, 10) },
            isStreaming: { el: streamingToggle, type: 'checked', default: true },
            isMarkdown: { el: markdownToggle, type: 'checked', default: true },
            isSendOnEnter: { el: sendOnEnterToggle, type: 'checked', default: false },
            isSaveHistory: { el: saveHistoryToggle, type: 'checked', default: true },
            autoHideOnSend: { el: autoHideOnSendToggle, type: 'checked', default: false },
            thinkingBudget: { el: thinkingBudgetSelect, type: 'value', default: '0' },
            quickPrompt1: { el: quickPrompt1Input, type: 'value', default: 'Explain:' },
            quickPrompt2: { el: quickPrompt2Input, type: 'value', default: 'Tell briefly:' },
        };

        function getSetting(key) { 
            const storedValue = localStorage.getItem(`settings_global_${key}`); 
            return storedValue !== null ? JSON.parse(storedValue) : settingsConfig[key].default; 
        }
        function saveSetting(key, value) { 
            localStorage.setItem(`settings_global_${key}`, JSON.stringify(value)); 
        }

        function loadAllSettings() {
            for (const key in settingsConfig) {
                const config = settingsConfig[key];
                const value = getSetting(key);
                if (config.el) {
                    config.el[config.type] = value;
                    if (config.displayEl && config.format) {
                        config.displayEl.textContent = config.format(value);
                    }
                }
            }
        }

        function saveAllSettings() { 
            for (const key in settingsConfig) {
                const config = settingsConfig[key];
                if (config.el) {
                    saveSetting(key, config.el[config.type]);
                }
            }
        }

        function setSendButtonState(state) { if (state === 'stop') { sendButton.innerHTML = stopIconSVG; sendButton.classList.add('stop-generating'); sendButton.setAttribute('aria-label', 'Stop Generating'); sendButton.disabled = false; } else { sendButton.innerHTML = sendIconSVG; sendButton.classList.remove('stop-generating'); sendButton.setAttribute('aria-label', 'Send Message'); } }
        function updateStatus(state, text = '') { let color = 'yellow'; let message = text; setSendButtonState('send'); sendButton.disabled = false; switch (state) { case 'ready': color = 'green'; message = `Ready`; break; case 'sending': color = 'yellow'; message = 'Sending'; sendButton.disabled = true; break; case 'generating': color = 'blue'; message = 'Generating'; setSendButtonState('stop'); break; case 'error': color = 'red'; message = `Error: ${text}`; break; case 'stopped': color = 'yellow'; message = 'Stopped'; break; default: message = 'Initializing...'; sendButton.disabled = true; } connectionStatus.innerHTML = `<span class="dot ${color}"></span>${message}`; }
        function truncatePrompt(text) { if (!text) return ''; const words = text.trim().split(' '); return words.length > 1 ? `${words[0]}...` : text; }
        function updateQuickPromptButtons() { 
            document.getElementById('quick-prompt-btn-1').textContent = truncatePrompt(getSetting('quickPrompt1')); 
            document.getElementById('quick-prompt-btn-2').textContent = truncatePrompt(getSetting('quickPrompt2')); 
        }
        function updateTemperatureControlState() { temperatureSliderContainer.classList.toggle('setting-disabled', !temperatureToggle.checked); }
        function updateTopPControlState() { topPSliderContainer.classList.toggle('setting-disabled', !topPToggle.checked); }
        function updateTopKControlState() { topKSliderContainer.classList.toggle('setting-disabled', !topKToggle.checked); }
        function updateThinkingBudgetControlState() { const selectedModel = modelSelect.value; thinkingBudgetContainer.classList.toggle('setting-disabled', !(selectedModel && selectedModel.includes('2.5'))); }
        async function fetchModels(isManualRefresh = false) { refreshModelsBtn.disabled = true; refreshModelsBtn.textContent = 'Refreshing...'; const apiKey = getSetting('apiKey') || DEFAULT_API_KEY; try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`); if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`); const data = await response.json(); const chatModels = data.models.filter(m => m.supportedGenerationMethods.includes('generateContent')).map(m => ({ id: m.name.split('/')[1], name: m.displayName })); localStorage.setItem('cachedModels', JSON.stringify(chatModels)); populateModelDropdown(chatModels); if (isManualRefresh) alert('Model list updated successfully!'); } catch (error) { console.error("Failed to fetch models:", error); updateStatus('error', 'Model fetch failed'); if (isManualRefresh) alert(`Could not refresh models. Error: ${error.message}`); } finally { refreshModelsBtn.disabled = false; refreshModelsBtn.textContent = 'Refresh Model List'; } }
        function populateModelDropdown(models) { const savedModel = localStorage.getItem('selectedModel'); const PREFERRED_DEFAULT_MODEL = 'gemini-1.5-flash-latest'; modelSelect.innerHTML = ''; if (!models || models.length === 0) { modelSelect.innerHTML = '<option>No models found</option>'; updateStatus('error', 'No models found'); return; } models.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.name; modelSelect.appendChild(option); }); if (savedModel && models.some(m => m.id === savedModel)) modelSelect.value = savedModel; else if (models.some(m => m.id === PREFERRED_DEFAULT_MODEL)) modelSelect.value = PREFERRED_DEFAULT_MODEL; else if (models.length > 0) modelSelect.value = models[0].id; localStorage.setItem('selectedModel', modelSelect.value); updateStatus('ready', modelSelect.options[modelSelect.selectedIndex].text); updateThinkingBudgetControlState(); }
        function hideBars() { statusBar.style.display = 'none'; chatForm.style.display = 'none'; showBarsBtn.style.display = 'flex'; pageDownBtn.style.display = 'flex'; }
        function showBars() { statusBar.style.display = 'flex'; chatForm.style.display = 'flex'; showBarsBtn.style.display = 'none'; pageDownBtn.style.display = 'none'; messageInput.focus(); }
        function showTypingIndicator(aiMessageElement) { const contentEl = aiMessageElement.querySelector('.content'); if (contentEl) contentEl.innerHTML = `<div class="typing-indicator"></div>`; }
        function appendIncompleteWarning(element, reason) { const warningDiv = document.createElement('div'); warningDiv.className = 'incomplete-warning'; warningDiv.innerHTML = `<strong>Response incomplete.</strong> Reason: ${reason}`; element.appendChild(warningDiv); smartScrollToBottom(); }
        function forceScrollToBottom() { chatWindow.scrollTop = chatWindow.scrollHeight; }
        function smartScrollToBottom() { const threshold = 100; const isScrolledToBottom = chatWindow.scrollHeight - chatWindow.clientHeight <= chatWindow.scrollTop + threshold; if (isScrolledToBottom) { forceScrollToBottom(); } }
        
        function renderAndProcessContent(text, element) {
            if (getSetting('isMarkdown') && window.marked && window.katex) {
                const katexSnippets = [];
                const PLACEHOLDER_PREFIX = "<!--LATEX_PLACEHOLDER_";
                const PLACEHOLDER_SUFFIX = "-->";
                let textWithPlaceholders = text.replace(/\$\$([\s\S]+?)\$\$|\$([\s\S]+?)\$/g, (match, displayMath, inlineMath) => {
                    const content = displayMath || inlineMath;
                    const isDisplay = !!displayMath;
                    try {
                        const renderedHtml = katex.renderToString(content.trim(), { throwOnError: false, displayMode: isDisplay });
                        katexSnippets.push(renderedHtml);
                        return `${PLACEHOLDER_PREFIX}${katexSnippets.length - 1}${PLACEHOLDER_SUFFIX}`;
                    } catch (e) { console.error("KaTeX Error:", e); return match; }
                });
                let markdownHtml = marked.parse(textWithPlaceholders);
                markdownHtml = markdownHtml.replace(new RegExp(`${PLACEHOLDER_PREFIX}(\\d+)${PLACEHOLDER_SUFFIX}`, "g"), (match, index) => {
                    return katexSnippets[parseInt(index, 10)];
                });
                element.innerHTML = markdownHtml;
                const tables = element.querySelectorAll('table');
                tables.forEach(table => {
                    if (table.parentNode.className !== 'table-wrapper') {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'table-wrapper';
                        table.parentNode.insertBefore(wrapper, table);
                        wrapper.appendChild(table);
                    }
                });
            } else { element.textContent = text; }
        }
        
        async function callGeminiAPI(prompt, aiMessageElement) {
            abortController = new AbortController();
            const apiKey = getSetting('apiKey') || DEFAULT_API_KEY;
            const model = modelSelect.value;
            if (!model || model === 'No models found') throw new Error("No model selected.");
            const generationConfig = {};
            if (getSetting('isTemperatureEnabled')) generationConfig.temperature = parseFloat(getSetting('temperature'));
            if (getSetting('isTopPEnabled')) generationConfig.topP = parseFloat(getSetting('topP'));
            if (getSetting('isTopKEnabled')) generationConfig.topK = parseInt(getSetting('topK'), 10);
            if (model.includes('2.5')) generationConfig.thinkingConfig = { thinkingBudget: parseInt(getSetting('thinkingBudget'), 10) };
            const safetySettings = getSetting('isSafetyDisabled') ? [ { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' }, { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' }, { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' }, { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }, ] : undefined;
            const historyForApi = chatHistory.slice(0, -1);
            const requestBody = { contents: [...historyForApi, { role: 'user', parts: [{ text: prompt }] }], systemInstruction: getSetting('systemPrompt') ? { role: "model", parts: [{ text: getSetting('systemPrompt') }] } : undefined, generationConfig: Object.keys(generationConfig).length > 0 ? generationConfig : undefined, safetySettings };
            const isStreaming = getSetting('isStreaming');
            const streamParam = isStreaming ? ':streamGenerateContent?alt=sse' : ':generateContent';
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}${streamParam}&key=${apiKey}`;
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), signal: abortController.signal });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`); }

            const contentEl = aiMessageElement.querySelector('.content');
            let fullText = '';
            if (isStreaming) {
                const { text, finishReason } = await processStream(response, contentEl);
                fullText = text;
                if (finishReason && finishReason !== 'STOP') appendIncompleteWarning(contentEl, finishReason);
            } else {
                aiMessageElement.querySelector('.typing-indicator')?.remove();
                contentEl.innerHTML = '';
                const data = await response.json();
                const candidate = data.candidates?.[0];
                if (candidate?.content?.parts?.[0]) {
                    fullText = candidate.content.parts[0].text;
                    renderAndProcessContent(fullText, contentEl);
                    if (candidate.finishReason && candidate.finishReason !== 'STOP') appendIncompleteWarning(contentEl, candidate.finishReason);
                } else {
                    fullText = "No content received from model.";
                    renderAndProcessContent(fullText, contentEl);
                }
            }
            aiMessageElement.dataset.rawText = fullText; // **STORE RAW TEXT ON THE ELEMENT**
            if (getSetting('isSaveHistory')) {
                const lastMessage = chatHistory[chatHistory.length -1];
                if (lastMessage && lastMessage.role === 'model') {
                    lastMessage.parts[0].text = fullText;
                } else {
                    chatHistory.push({ role: 'model', parts: [{ text: fullText }] });
                }
            }
        }
        async function processStream(response, contentEl) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            let buffer = '';
            let lastFinishReason = null;
            let isFirstChunk = true;
            while (true) {
                if (abortController.signal.aborted) { reader.cancel(); throw new DOMException('Aborted by user', 'AbortError'); }
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            const candidate = json.candidates?.[0];
                            if (candidate) {
                                if (candidate.content?.parts?.[0].text) {
                                    if (isFirstChunk) { 
                                        contentEl.innerHTML = ''; 
                                        isFirstChunk = false; 
                                        if (getSetting('isSaveHistory')) { chatHistory.push({ role: 'model', parts: [{ text: '' }] }); }
                                    }
                                    fullText += candidate.content.parts[0].text;
                                    renderAndProcessContent(fullText, contentEl);
                                    smartScrollToBottom();
                                }
                                if (candidate.finishReason) lastFinishReason = candidate.finishReason;
                            }
                        } catch (e) { console.warn("Could not parse stream chunk:", line); }
                    }
                }
            }
            return { text: fullText, finishReason: lastFinishReason };
        }
        async function handleApiCall(prompt, aiMessageElement) { showTypingIndicator(aiMessageElement); updateStatus('generating'); try { await callGeminiAPI(prompt, aiMessageElement); } catch (error) { if (error.name === 'AbortError') { console.log('API call aborted by user.'); const contentEl = aiMessageElement.querySelector('.content'); if (!contentEl.innerText.trim()) contentEl.innerHTML = `<p style="color:var(--text-secondary-color);">Generation stopped.</p>`; updateStatus('stopped'); } else { console.error("API Call Failed:", error); const errorMessage = error.message || "An unknown error occurred."; updateStatus('error', 'Response failed'); aiMessageElement.dataset.failedPrompt = prompt; const contentEl = aiMessageElement.querySelector('.content'); contentEl.innerHTML = `<div class="error-container"><p><strong>Error:</strong> ${errorMessage}</p><button class="retry-btn"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6"/><path d="M2 11.5A10 10 0 0 1 12 2a10 10 0 0 1 10 10"/><path d="M22 12.5a10 10 0 0 1-10 10 10 10 0 0 1-10-10"/></svg>Retry</button></div>`; } } finally { abortController = null; if (connectionStatus.innerText.includes('Generating')) updateStatus('ready', modelSelect.options[modelSelect.selectedIndex].text); } }
        function addMessage(text, role) { const messageDiv = document.createElement('div'); messageDiv.className = `message ${role}`; const contentDiv = document.createElement('div'); contentDiv.className = 'content'; if (role === 'user') { contentDiv.textContent = text; } messageDiv.appendChild(contentDiv); if (role === 'ai') { const btnContainer = document.createElement('div'); btnContainer.className = 'message-buttons'; const copyButton = document.createElement('button'); copyButton.className = 'copy-btn'; copyButton.title = 'Copy'; copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`; const exportButton = document.createElement('button'); exportButton.className = 'export-msg-btn'; exportButton.title = 'Export Response'; exportButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`; btnContainer.appendChild(copyButton); btnContainer.appendChild(exportButton); messageDiv.appendChild(btnContainer); } chatWindow.appendChild(messageDiv); smartScrollToBottom(); return messageDiv; }
        function saveChatHistory() { if (getSetting('isSaveHistory')) localStorage.setItem('chatHistory', JSON.stringify(chatHistory)); }
        function loadChatHistory() { if (!getSetting('isSaveHistory')) { localStorage.removeItem('chatHistory'); chatHistory = []; return false; } const savedHistory = localStorage.getItem('chatHistory'); if (savedHistory && JSON.parse(savedHistory).length > 0) { chatHistory = JSON.parse(savedHistory); chatWindow.innerHTML = ''; chatHistory.forEach(msg => { const messageElement = addMessage(msg.parts[0].text, msg.role); if (msg.role === 'ai') { messageElement.dataset.rawText = msg.parts[0].text; renderAndProcessContent(msg.parts[0].text, messageElement.querySelector('.content')); } }); return true; } chatHistory = []; return false; }
        function startNewConversation() { chatHistory = []; localStorage.removeItem('chatHistory'); chatWindow.innerHTML = ''; const initialPrompt = "hello"; addMessage(initialPrompt, 'user'); if (getSetting('isSaveHistory')) chatHistory.push({ role: 'user', parts: [{ text: initialPrompt }] }); const aiMessageElement = addMessage('', 'ai'); handleApiCall(initialPrompt, aiMessageElement); }
        
        // --- MODIFICATION: New Scrolling Function ---
        function scrollToLastUserMessage() {
            const userMessages = chatWindow.querySelectorAll('.message.user');
            if (userMessages.length > 0) {
                const lastUserMessage = userMessages[userMessages.length - 1];
                lastUserMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- Original Scrolling Function (Kept for reference or other uses) ---
        function scrollByMessage(direction) {
            const messages = Array.from(chatWindow.querySelectorAll('.message'));
            if (messages.length === 0) return;

            const viewportTop = chatWindow.scrollTop;

            if (direction === 'next') {
                const targetMessage = messages.find(msg => msg.offsetTop > viewportTop + 1);
                if (targetMessage) {
                    targetMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
                }
            } else if (direction === 'prev') {
                const targetMessage = messages.slice().reverse().find(msg => msg.offsetTop < viewportTop - 1);
                if (targetMessage) {
                    targetMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    chatWindow.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        }

        // --- Event Listeners ---
        newChatBtn.addEventListener('click', startNewConversation);
        mainSettingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
        closeSettingsBtn.addEventListener('click', () => { settingsModal.classList.remove('active'); saveAllSettings(); });
        refreshModelsBtn.addEventListener('click', () => fetchModels(true));
        exportPdfBtn.addEventListener('click', () => { if (chatHistory.length === 0) { alert("Chat is empty."); return; } window.print(); });
        exportTxtBtn.addEventListener('click', () => { if (chatHistory.length === 0) { alert("Chat is empty."); return; } const txtContent = chatHistory.map(message => `[${message.role.toUpperCase()}]\n${message.parts[0].text}\n\n`).join('---\n'); const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `samar-ai-chat-${new Date().toISOString()}.txt`; a.click(); URL.revokeObjectURL(url); });
        modelSelect.addEventListener('change', () => { localStorage.setItem('selectedModel', modelSelect.value); updateStatus('ready', modelSelect.options[modelSelect.selectedIndex].text); updateThinkingBudgetControlState(); });
        messageInput.addEventListener('input', () => { messageInput.style.height = 'auto'; messageInput.style.height = (messageInput.scrollHeight) + 'px'; });
        messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && getSetting('isSendOnEnter')) { e.preventDefault(); chatForm.requestSubmit(); } });
        hideBarsBtn.addEventListener('click', hideBars);
        showBarsBtn.addEventListener('click', showBars);
        
        // MODIFICATION: Changed button listeners to use the new function
        pageDownBtn.addEventListener('click', scrollToLastUserMessage); 
        
        document.querySelector('#top-input-bar').addEventListener('click', (e) => { if (e.target.classList.contains('quick-prompt-btn')) { const buttonId = e.target.id; let fullPromptText = ''; if (buttonId === 'quick-prompt-btn-1') fullPromptText = getSetting('quickPrompt1'); else if (buttonId === 'quick-prompt-btn-2') fullPromptText = getSetting('quickPrompt2'); else if (e.target.textContent.toLowerCase() === 'input') { messageInput.focus(); return; } messageInput.value += (messageInput.value.trim() ? ' ' : '') + fullPromptText + ' '; messageInput.focus(); messageInput.dispatchEvent(new Event('input', { bubbles: true })); } });
        
        // MODIFICATION: Updated scroll button listeners
        scrollToTopBtn.addEventListener('click', () => scrollByMessage('prev')); // This remains for scrolling up
        scrollToBottomBtn.addEventListener('click', scrollToLastUserMessage); // This now scrolls to the last user message
        
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && settingsModal.classList.contains('active')) closeSettingsBtn.click(); });
        
        temperatureToggle.addEventListener('change', updateTemperatureControlState);
        topPToggle.addEventListener('change', updateTopPControlState);
        topKToggle.addEventListener('change', updateTopKControlState);
        
        for (const key in settingsConfig) {
            const config = settingsConfig[key];
            if (config.el && config.el.type === 'range') {
                config.el.addEventListener('input', (e) => {
                    config.displayEl.textContent = config.format(e.target.value);
                    saveSetting(key, e.target.value);
                });
            }
        }
        
        quickPrompt1Input.addEventListener('input', (e) => { saveSetting('quickPrompt1', e.target.value); updateQuickPromptButtons(); });
        quickPrompt2Input.addEventListener('input', (e) => { saveSetting('quickPrompt2', e.target.value); updateQuickPromptButtons(); });

        chatForm.addEventListener('submit', async (e) => { e.preventDefault(); if (abortController) { abortController.abort(); messageInput.focus(); return; } const userInput = messageInput.value.trim(); if (!userInput) return; if (getSetting('autoHideOnSend')) hideBars(); addMessage(userInput, 'user'); if (getSetting('isSaveHistory')) chatHistory.push({ role: 'user', parts: [{ text: userInput }] }); messageInput.value = ''; messageInput.dispatchEvent(new Event('input', { bubbles: true })); messageInput.focus(); const aiMessageElement = addMessage('', 'ai'); await handleApiCall(userInput, aiMessageElement); });
        chatWindow.addEventListener('click', async (e) => { 
            const button = e.target.closest('button');
            if (!button) return;
            const messageEl = button.closest('.message.ai');

            if (button.classList.contains('copy-btn')) { 
                try { 
                    const contentEl = messageEl.querySelector('.content');
                    await navigator.clipboard.writeText(contentEl.innerText); 
                    button.innerHTML = '✓'; 
                    button.classList.add('copied'); 
                    setTimeout(() => { 
                        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`; 
                        button.classList.remove('copied'); 
                    }, 1500); 
                } catch (err) { console.error('Failed to copy text: ', err); } 
            } else if (button.classList.contains('export-msg-btn')) {
                if (!messageEl || !messageEl.dataset.rawText) return;
                const rawText = messageEl.dataset.rawText;
                const blob = new Blob([rawText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ai-response.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else if (button.classList.contains('retry-btn')) { 
                const failedPrompt = messageEl.dataset.failedPrompt; 
                if (messageEl && failedPrompt) { 
                    messageEl.querySelector('.content').innerHTML = ''; 
                    await handleApiCall(failedPrompt, messageEl, false); 
                } 
            } 
        });
        
        // Initialization
        async function initializeApp() { 
            setSendButtonState('send'); 
            loadAllSettings(); 
            updateQuickPromptButtons(); 
            updateTemperatureControlState(); 
            updateTopPControlState(); 
            updateTopKControlState(); 
            updateThinkingBudgetControlState(); 
            const cachedModels = localStorage.getItem('cachedModels'); 
            if (cachedModels) {
                populateModelDropdown(JSON.parse(cachedModels));
            } else {
                await fetchModels(); 
            }
            const historyWasLoaded = loadChatHistory(); 
            if (!historyWasLoaded) {
                startNewConversation(); 
            }
            window.addEventListener('beforeunload', saveChatHistory); 
            messageInput.focus(); 
        }
        initializeApp();
    });
</script>
<script>if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(registration => { console.log('SW registered: ', registration.scope); }, err => { console.log('SW registration failed: ', err); }); }); }</script>
</body>
</html>
